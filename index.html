<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Escape SAMR - MTAC en Tabasco</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body {
      margin: 0;
      padding: 0;
      background: radial-gradient(circle at top, #1d2538 0, #111827 35%, #020617 75%, #000000 100%);
      color: #f5f5f5;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      overflow-x: hidden;
    }

    .game-container {
      background: rgba(7, 16, 40, 0.95);
      border-radius: 20px;
      padding: 20px 24px;
      max-width: 1000px;
      width: 95%;
      box-shadow: 0 18px 40px rgba(0,0,0,0.7);
      margin: 12px;
      border: 2px solid rgba(148,163,184,0.35);
      position: relative;
      overflow: hidden;
    }

    .game-container::before {
      content: "";
      position: absolute;
      inset: -40%;
      background:
        radial-gradient(circle at 10% 20%, rgba(236, 72, 153, 0.18) 0, transparent 50%),
        radial-gradient(circle at 80% 0%, rgba(56, 189, 248, 0.2) 0, transparent 55%),
        radial-gradient(circle at 50% 100%, rgba(129, 140, 248, 0.22) 0, transparent 50%);
      opacity: 0.9;
      z-index: -1;
      animation: glowMove 16s linear infinite alternate;
    }

    @keyframes glowMove {
      from { transform: translate3d(-10px, 10px, 0); }
      to   { transform: translate3d(10px, -10px, 0); }
    }

    h1, h2, h3 {
      margin-top: 0;
    }

    h1 {
      font-size: 1.9rem;
      text-align: center;
      text-shadow: 0 0 8px rgba(0,0,0,0.6);
    }

    .subtitle {
      text-align: center;
      font-size: 0.95rem;
      color: #a5b4fc;
      margin-bottom: 16px;
    }

    .hidden {
      display: none;
    }

    .input-group {
      margin: 12px 0;
    }

    label {
      font-size: 0.9rem;
      display: block;
      margin-bottom: 4px;
    }

    input[type="text"] {
      width: 100%;
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid rgba(148,163,184,0.8);
      outline: none;
      background: rgba(15,23,42,0.9);
      color: #f5f5f5;
    }

    input[type="text"]::placeholder {
      color: rgba(148,163,184,0.8);
    }

    button {
      border: none;
      border-radius: 999px;
      padding: 9px 20px;
      cursor: pointer;
      font-weight: 600;
      margin: 4px;
      transition: transform 0.1s ease, box-shadow 0.1s ease, background 0.2s ease, opacity 0.2s ease, border 0.2s ease;
      font-size: 0.9rem;
    }

    button.primary {
      background: linear-gradient(135deg, #6366f1, #ec4899);
      color: #f9fafb;
      box-shadow: 0 4px 14px rgba(79,70,229,0.75);
      border: 1px solid rgba(248,250,252,0.18);
    }

    button.primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 8px 22px rgba(79,70,229,0.9);
    }

    button.secondary {
      background: linear-gradient(135deg, #0ea5e9, #22c55e);
      color: #011627;
      box-shadow: 0 3px 10px rgba(15,23,42,0.8);
      border: 1px solid rgba(148,163,184,0.5);
    }

    button.secondary:hover {
      transform: translateY(-1px);
      box-shadow: 0 6px 16px rgba(15,23,42,0.9);
    }

    button.option-btn {
      width: 100%;
      text-align: left;
      margin-top: 6px;
      background: rgba(15,23,42,0.9);
      color: #f5f5f5;
      border-radius: 12px;
      border: 1px solid rgba(30,64,175,0.7);
      white-space: normal;
      backdrop-filter: blur(4px);
    }

    button.option-btn:hover {
      background: rgba(30,64,175,0.9);
    }

    button.option-btn.selected {
      border-color: #a855f7;
      background: radial-gradient(circle at top left, rgba(168,85,247,0.3), rgba(15,23,42,0.95));
      box-shadow: 0 0 14px rgba(168,85,247,0.7);
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      box-shadow: none;
      transform: none;
    }

    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      gap: 8px;
      flex-wrap: wrap;
    }

    .top-actions {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .top-actions-panel {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .top-actions-toggle {
      display: none;
    }

    .icon-btn {
      border: 1px solid rgba(148,163,184,0.5);
      background: linear-gradient(135deg, #0ea5e9, #22c55e);
      color: #011627;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 1rem;
      box-shadow: 0 3px 10px rgba(15,23,42,0.8);
    }

    .level-info {
      font-size: 0.9rem;
    }

    .progress-container {
      background: rgba(31,41,55,0.95);
      border-radius: 999px;
      overflow: hidden;
      height: 14px;
      flex: 1;
      min-width: 120px;
      box-shadow: 0 0 0 1px rgba(15,23,42,0.9);
    }

    .progress-bar {
      height: 100%;
      background: linear-gradient(90deg, #22c55e, #eab308, #f97316, #ef4444);
      width: 0%;
      transition: width 0.3s ease;
    }

    .story-box, .question-box, .feedback-box {
      background: linear-gradient(135deg, rgba(15,23,42,0.95), rgba(15,23,64,0.98));
      border-radius: 14px;
      padding: 12px 14px;
      margin-top: 10px;
      font-size: 0.9rem;
      border: 1px solid rgba(30,64,175,0.8);
    }

    .story-box {
      border-left: 3px solid #ec4899;
    }

    .story-title {
      font-weight: 700;
      font-size: 0.9rem;
      margin-bottom: 6px;
      color: #f0abfc;
    }

    .question-title {
      font-weight: 600;
      margin-bottom: 6px;
    }

    .question-box {
      border-left: 3px solid #6366f1;
    }

    .feedback-box.correct {
      border-left: 3px solid #22c55e;
      color: #bbf7d0;
    }

    .feedback-box.incorrect {
      border-left: 3px solid #ef4444;
      color: #fecaca;
    }

    .actions {
      margin-top: 10px;
      display: flex;
      justify-content: flex-end;
      gap: 6px;
      flex-wrap: wrap;
    }

    .stars {
      color: #c4b5fd;
      font-size: 1.1rem;
      text-shadow: 0 0 6px rgba(15,23,42,0.7);
    }
    .streak-box {
      margin-top: 6px;
      padding: 6px 8px;
      border: 1px solid rgba(34,197,94,0.35);
      border-radius: 10px;
      background: radial-gradient(circle at top left, rgba(34,197,94,0.15), rgba(2,6,23,0.85));
      color: #e5e7eb;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 0.9rem;
    }
    .streak-box.hidden { display: none; }
    .badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      border: 1px solid rgba(129,140,248,0.35);
      border-radius: 999px;
      background: radial-gradient(circle at top left, rgba(129,140,248,0.15), rgba(2,6,23,0.85));
      color: #e5e7eb;
      font-size: 0.9rem;
      margin-right: 6px;
      white-space: nowrap;
    }

    .level-summary, .final-summary {
      margin-top: 16px;
      background: linear-gradient(135deg, rgba(15,23,42,0.98), rgba(15,23,64,0.98));
      border-radius: 14px;
      padding: 12px 14px;
      font-size: 0.9rem;
      border: 1px solid rgba(30,64,175,0.7);
    }

    .levels-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 10px;
      margin-top: 8px;
    }

    .level-card {
      background: radial-gradient(circle at top, rgba(129,140,248,0.16), rgba(15,23,42,0.96));
      border-radius: 12px;
      padding: 10px;
      font-size: 0.85rem;
      border: 1px solid rgba(51,65,85,0.9);
    }

    .level-card h4 {
      margin: 0 0 4px 0;
      font-size: 0.95rem;
    }

    .glosario {
      margin-top: 10px;
      font-size: 0.85rem;
      background: linear-gradient(135deg, rgba(15,23,42,0.98), rgba(31,41,89,0.98));
      border-radius: 14px;
      padding: 10px 12px;
      border: 1px solid rgba(148,163,184,0.7);
    }

    .tag {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 0.75rem;
      background: rgba(148,163,184,0.8);
      margin-right: 4px;
      margin-bottom: 4px;
      color: #020617;
    }

    .small {
      font-size: 0.8rem;
      opacity: 0.9;
    }

    /* Personaje */
    .character-panel {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-top: 8px;
      background: linear-gradient(135deg, rgba(15,23,42,0.98), rgba(30,64,175,0.98));
      border-radius: 14px;
      padding: 8px 10px;
      border: 1px solid rgba(148,163,184,0.8);
    }

    .avatar-circle {
      width: 52px;
      height: 52px;
      border-radius: 50%;
      background: radial-gradient(circle at 30% 20%, rgba(56,189,248,0.9), rgba(15,23,42,1));
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.9rem;
      box-shadow: 0 0 0 2px rgba(148,163,184,0.9), 0 0 14px rgba(56,189,248,0.9);
      animation: pulseAvatar 1.6s ease-in-out infinite;
      overflow: hidden;
    }

    .avatar-circle img {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
    }

    @keyframes pulseAvatar {
      0%   { transform: scale(1); box-shadow: 0 0 0 2px rgba(148,163,184,0.9), 0 0 14px rgba(56,189,248,0.8); }
      50%  { transform: scale(1.05); box-shadow: 0 0 0 3px rgba(248,250,252,0.9), 0 0 22px rgba(129,140,248,1); }
      100% { transform: scale(1); box-shadow: 0 0 0 2px rgba(148,163,184,0.9), 0 0 14px rgba(56,189,248,0.8); }
    }

    .char-name {
      font-weight: 600;
      font-size: 0.95rem;
    }

    .char-role {
      font-size: 0.8rem;
      color: #d2e0ff;
    }

    /* Pantalla MAPA del mundo */
    .map-grid {
      display: grid;
      grid-template-columns: minmax(0, 2fr) minmax(0, 1.5fr);
      gap: 12px;
      margin-top: 12px;
    }

    .map-card {
      background: linear-gradient(135deg, rgba(15,23,42,0.98), rgba(30,64,175,0.98));
      border-radius: 16px;
      padding: 10px 12px;
      border: 1px solid rgba(148,163,184,0.8);
    }

    .character-options {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-top: 8px;
    }

    .character-card {
      display: flex;
      align-items: center;
      gap: 10px;
      background: rgba(15,23,42,0.98);
      border-radius: 12px;
      padding: 8px 10px;
      border: 1px solid rgba(51,65,85,0.9);
      cursor: pointer;
      text-align: left;
    }

    .character-card:hover {
      border-color: #6366f1;
    }

    .character-card.selected {
      border-color: #a855f7;
      box-shadow: 0 0 16px rgba(168,85,247,0.9);
      background: radial-gradient(circle at top left, rgba(168,85,247,0.35), rgba(15,23,42,0.98));
    }

    .character-avatar {
      width: 56px;
      height: 56px;
      border-radius: 50%;
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
      background: radial-gradient(circle, rgba(56,189,248,0.9), rgba(15,23,42,1));
    }

    .character-avatar img {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
    }

    .char-card-info-title {
      font-weight: 600;
      font-size: 0.95rem;
      color: #fef3c7;
      text-shadow: 0 0 6px rgba(0,0,0,0.6);
      background: radial-gradient(circle at top left, rgba(250,204,21,0.18), rgba(2,6,23,0.7));
      border: 1px solid rgba(250,204,21,0.35);
      padding: 4px 8px;
      border-radius: 10px;
      display: inline-block;
    }

    .char-card-info-sub {
      font-size: 0.8rem;
      color: #e5e7eb;
    }

    /* Overlay men√∫ de niveles */
    .overlay {
      position: fixed;
      inset: 0;
      background: radial-gradient(circle at top, rgba(129,140,248,0.25), rgba(0,0,0,0.9));
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 999;
      padding: 12px;
      backdrop-filter: blur(3px);
    }

    .overlay.hidden {
      display: none;
    }

    .level-complete {
      background: linear-gradient(135deg, #020617, #020617, #111827);
      border-radius: 16px;
      border: 1px solid rgba(129,140,248,0.25);
      box-shadow: 0 10px 35px rgba(0,0,0,0.5);
      padding: 16px;
      color: #e5e7eb;
      width: min(720px, 96vw);
      max-height: 90vh;
      overflow: auto;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .confetti-piece {
      position: fixed;
      top: -10px;
      width: 8px;
      height: 14px;
      opacity: 0.9;
      border-radius: 2px;
      will-change: transform;
      animation-name: confetti-fall, confetti-tilt;
      animation-timing-function: linear, ease-in-out;
      animation-fill-mode: forwards;
    }
    @keyframes confetti-fall {
      to { transform: translateY(105vh) rotate(720deg); opacity: 1; }
    }
    @keyframes confetti-tilt {
      0% { transform: translateY(0) rotate(0deg); }
      50% { transform: translateY(52vh) rotate(360deg); }
      100% { transform: translateY(105vh) rotate(720deg); }
    }
    .shake {
      animation: shake 0.4s;
    }
    @keyframes shake {
      10%, 90% { transform: translateX(-1px); }
      20%, 80% { transform: translateX(2px); }
      30%, 50%, 70% { transform: translateX(-4px); }
      40%, 60% { transform: translateX(4px); }
    }
    button.option-btn { position: relative; overflow: hidden; }
    .ripple {
      position: absolute;
      border-radius: 50%;
      transform: scale(0);
      opacity: 0.5;
      background: rgba(255,255,255,0.35);
      pointer-events: none;
      animation: ripple 550ms ease-out forwards;
    }
    @keyframes ripple { to { transform: scale(1); opacity: 0; } }
    .pulse { animation: pulse 500ms ease-in-out; }
    @keyframes pulse { 0% { transform: scale(1); box-shadow: 0 0 0 rgba(255,255,255,0); } 50% { transform: scale(1.03); box-shadow: 0 0 18px rgba(129,140,248,0.4); } 100% { transform: scale(1); box-shadow: 0 0 0 rgba(255,255,255,0); } }
    .pop-in { animation: popin 300ms ease-out; }
    @keyframes popin { from { transform: scale(0.92); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    .stars.glint { animation: glint 1200ms ease-in-out; }
    @keyframes glint { 0% { filter: brightness(1); } 50% { filter: brightness(1.6); text-shadow: 0 0 10px rgba(196,181,253,0.8); } 100% { filter: brightness(1); } }
    .screen-flash { position: fixed; inset: 0; z-index: 1000; pointer-events: none; animation: flash 350ms ease-out forwards; }
    @keyframes flash { from { opacity: 0; } 15% { opacity: 1; } to { opacity: 0; } }

    .level-menu {
      background: linear-gradient(135deg, #020617, #020617, #111827);
      border-radius: 16px;
      padding: 16px 18px;
      max-width: 600px;
      width: 100%;
      box-shadow: 0 12px 24px rgba(0,0,0,0.8);
      border: 1px solid rgba(148,163,184,0.9);
    }

    .level-menu-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      margin-bottom: 6px;
    }

    .status-label {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 0.75rem;
    }

    .status-unlocked {
      background: rgba(46, 213, 115, 0.18);
      color: #4ade80;
    }

    .status-locked {
      background: rgba(239, 68, 68, 0.18);
      color: #fecaca;
    }

    .status-current {
      background: rgba(168, 85, 247, 0.25);
      color: #c4b5fd;
    }

    /* Responsive */
    @media (max-width: 768px) {
      body {
        align-items: flex-start;
      }
      .game-container {
        padding: 16px;
        margin: 8px;
      }
      h1 {
        font-size: 1.6rem;
      }
      .top-bar {
        flex-direction: column;
        align-items: stretch;
      }
      .actions {
        justify-content: center;
      }
      button {
        font-size: 0.85rem;
      }
      .level-menu {
        max-height: 90vh;
        overflow-y: auto;
      }
      .map-grid {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    @media (max-width: 480px) {
      h1 {
        font-size: 1.4rem;
      }
      .subtitle {
        font-size: 0.85rem;
      }
      .character-panel {
        flex-direction: row;
      }
      .avatar-circle {
        width: 46px;
        height: 46px;
        font-size: 1.6rem;
      }
      button.primary, button.secondary {
        width: 100%;
        text-align: center;
      }

      .top-actions-toggle {
        display: inline-block;
        width: auto;
      }

      .top-actions-panel {
        display: none;
      }

      .top-actions-panel.open {
        display: flex;
        flex-wrap: wrap;
      }

      .icon-btn {
        width: 34px;
        height: 34px;
      }
    }
  </style>
</head>
<body>
<div class="game-container">

  <!-- PANTALLA DE INICIO -->
  <section id="screen-start">
    <h1>Escape SAMR ‚Äì Misi√≥n MTAC en Tabasco</h1>
    <p class="subtitle">
      Est√°s atrapado en una zona peligrosa de Tabasco. Solo dominando el modelo SAMR podr√°s encontrar la ruta de escape.
    </p>

    <div class="story-box">
      <p>
        Una tormenta el√©ctrica ha dejado incomunicado el complejo de investigaci√≥n <strong>‚ÄúLa Zona Roja de Tabasco‚Äù</strong>.
        Como estudiante de la <strong>MTAC</strong>, est√°s participando en una estancia acad√©mica‚Ä¶ hasta que todo se sale de control.
      </p>
      <div id="startStoryExtra" class="hidden">
        <p>
          Los sistemas de seguridad bloquean las salidas y aparece un mensaje en la pantalla central:
          <em>‚ÄúSolo quienes comprendan el modelo SAMR podr√°n desbloquear las puertas‚Äù.</em>
        </p>
      </div>
      <div class="actions" style="justify-content:flex-start; margin-top:8px;">
        <button class="secondary" id="startStoryToggleBtn" onclick="toggleStartStory()">Leer m√°s</button>
      </div>
    </div>

    <div class="character-panel">
      <div class="avatar-circle">üßë‚Äçüíª</div>
      <div>
        <div class="char-name" id="startCharName">Agente: Estudiante MTAC</div>
        <div class="char-role small">Listo para enfrentar la Zona Roja de Tabasco.</div>
      </div>
    </div>

    <div class="input-group">
      <label for="playerName">Escribe tu nombre (para que la misi√≥n sea personalizada):</label>
      <input type="text" id="playerName" placeholder="Ejemplo: Ana, Luis, etc.">
    </div>

    <button class="primary" onclick="startGame()">Comenzar misi√≥n</button>

    <div class="actions" style="justify-content:flex-start; margin-top:12px;">
      <button class="secondary" id="toggleDocNoteBtn" onclick="toggleDocNote()">Ver nota para docentes</button>
    </div>
    <div id="docNoteBox" class="glosario small hidden" style="margin-top:8px;">
      <strong>Nota para docentes:</strong><br>
      Este juego trabaja el modelo SAMR (definici√≥n, niveles y ventajas) a trav√©s de
      preguntas de opci√≥n m√∫ltiple, verdadero/falso y casos pr√°cticos. Ideal para estudiantes de universidad (MTAC).
    </div>
  </section>

  <!-- PANTALLA DE MAPA DEL MUNDO + SELECCI√ìN DE PERSONAJE -->
  <section id="screen-map" class="hidden">
    <h1>Mapa del mundo ‚Äì Escape SAMR</h1>
    <p class="subtitle">
      Bienvenido, <span id="mapPlayerName"></span>. Elige tu punto de inicio y tu h√©roe para escapar de la Zona Roja.
    </p>

    <div class="map-grid">
      <div class="map-card">
        <h3>Mapa de niveles</h3>
        <p class="small">
          Cada zona del mapa representa un nivel del modelo SAMR. Solo puedes avanzar en orden,
          pero podr√°s volver a niveles anteriores para mejorar tus estrellas.
        </p>
        <div class="levels-grid" id="worldLevelGrid"></div>
      </div>

      <div class="map-card">
        <h3>Elige tu personaje</h3>
        <p class="small">Selecciona el personaje con el que quieres vivir esta misi√≥n.</p>
        <div class="character-options">
          <button type="button" class="character-card" id="char-spiderman" onclick="chooseCharacter('spiderman')">
            <div class="character-avatar">
              <img src="https://www.pixilart.com/art/spiderman-0b248252796f0db" alt="Spider-Man">
            </div>
            <div>
              <div class="char-card-info-title">Spider-Man</div>
              <div class="char-card-info-sub">H√©roe √°gil y estrat√©gico. Ideal para salir de cualquier enredo tecnol√≥gico.</div>
            </div>
          </button>

          <button type="button" class="character-card" id="char-harley" onclick="chooseCharacter('harley')">
            <div class="character-avatar">
              <img src="https://blerp.com/soundbites/61a819004b0ecb37a2a763b9" alt="Harley Quinn">
            </div>
            <div>
              <div class="char-card-info-title">Harley Quinn</div>
              <div class="char-card-info-sub">Arriesgada y creativa. Perfecta para redefinir cualquier actividad del aula.</div>
            </div>
          </button>
        </div>
        <p class="small" style="margin-top:8px;">
          Personaje seleccionado: <strong id="selectedCharacterLabel"></strong>
        </p>
      </div>
    </div>

    <div class="actions" style="justify-content: space-between; margin-top:14px;">
      <button class="secondary" onclick="backToStart()">Cambiar nombre</button>
      <button class="primary" onclick="goToSuggestedLevel()">Ir al nivel sugerido</button>
    </div>
  </section>

  <!-- PANTALLA DE JUEGO PRINCIPAL -->
  <section id="screen-game" class="hidden">
    <div class="top-bar">
      <div class="level-info">
        <div id="playerLabel"></div>
        <div id="levelLabel"></div>
      </div>
      <div class="progress-container" title="Progreso de escape">
        <div id="progressBar" class="progress-bar"></div>
      </div>
      <div class="top-actions">
        <button type="button" class="secondary top-actions-toggle" id="actionsToggleBtn" onclick="toggleActionsPanel()">Acciones ‚ñæ</button>
        <div id="actionsPanel" class="top-actions-panel">
          <button class="secondary" onclick="openLevelMenu()">Mapa de niveles</button>
          <button class="secondary" onclick="toggleGlosario()">Ayuda / Glosario</button>
        </div>
      </div>
    </div>

    <div class="character-panel">
      <div class="avatar-circle">
        <img id="gameAvatarImg" alt="Personaje seleccionado">
      </div>
      <div>
        <div class="char-name" id="charName"></div>
        <div class="char-role small">Estudiante MTAC atrapado en ‚ÄúLa Zona Roja de Tabasco‚Äù.</div>
      </div>
    </div>

    <div id="glosarioBox" class="glosario hidden">
      <h3>Glosario SAMR</h3>
      <p><span class="tag">S</span><strong>Sustituci√≥n</strong>: la tecnolog√≠a act√∫a como un simple reemplazo de la herramienta tradicional, sin cambios significativos en la tarea.</p>
      <p><span class="tag">A</span><strong>Aumento</strong>: la tecnolog√≠a sigue sustituyendo, pero con mejoras funcionales que hacen la tarea m√°s eficiente o c√≥moda.</p>
      <p><span class="tag">M</span><strong>Modificaci√≥n</strong>: la tecnolog√≠a permite redise√±ar de forma importante la tarea, cambiando la forma en que los estudiantes trabajan.</p>
      <p><span class="tag">R</span><strong>Redefinici√≥n</strong>: la tecnolog√≠a posibilita tareas nuevas que antes eran imposibles o muy dif√≠ciles de realizar.</p>
      <hr>
      <p><strong>Ventajas del modelo SAMR:</strong></p>
      <ul>
        <li>Ayuda a reflexionar sobre c√≥mo se integra la tecnolog√≠a en el aula.</li>
        <li>Permite avanzar de un uso b√°sico a uno transformador.</li>
        <li>Facilita dise√±ar experiencias de aprendizaje m√°s significativas y aut√©nticas.</li>
      </ul>
    </div>

    <div class="story-box" id="storyBox"></div>

    <div class="question-box">
      <div class="question-title" id="questionTitle"></div>
      <div id="questionText"></div>
      <div id="optionsContainer"></div>
    </div>

    <div id="feedbackBox" class="feedback-box hidden"></div>
    <div id="streakBox" class="streak-box hidden"></div>

    <div class="actions">
      <button class="secondary hidden" id="repeatLevelBtn" onclick="repeatLevel()">Repetir nivel</button>
      <button class="secondary hidden" id="goToMapBtn" onclick="backToWorldMap()">Mapa del mundo</button>
      <button class="primary" id="nextBtn" onclick="nextStep()">Responder</button>
    </div>

    <div id="levelSummary" class="level-summary hidden"></div>
  </section>

  <!-- PANTALLA DE RESUMEN FINAL -->
  <section id="screen-final" class="hidden">
    <h2>Resumen de tu escape</h2>
    <p id="finalIntro"></p>

    <div class="final-summary">
      <h3>Estrellas por nivel</h3>
      <div class="levels-grid" id="levelsGrid"></div>
      <hr>
      <h3>Comentario general</h3>
      <p id="finalComment"></p>
    </div>

    <div class="actions" style="justify-content:space-between;">
      <button class="secondary" onclick="showGlosarioFinal()">Ver glosario SAMR</button>
      <button class="primary" onclick="resetGame()">Volver a jugar</button>
    </div>

    <div id="finalGlosario" class="glosario hidden">
      <h3>Glosario SAMR (recordatorio)</h3>
      <p><strong>Sustituci√≥n:</strong> la tecnolog√≠a reemplaza la herramienta tradicional sin cambiar la tarea.</p>
      <p><strong>Aumento:</strong> la tecnolog√≠a a√±ade mejoras funcionales a esa tarea.</p>
      <p><strong>Modificaci√≥n:</strong> la tecnolog√≠a permite redise√±ar la actividad de forma notable.</p>
      <p><strong>Redefinici√≥n:</strong> la tecnolog√≠a hace posible tareas nuevas que antes no se pod√≠an realizar.</p>
      <p><strong>Ventajas:</strong> gu√≠a el dise√±o did√°ctico, ayuda a planear mejor el uso de tecnolog√≠a y orienta hacia experiencias transformadoras.</p>
    </div>
  </section>

  <!-- OVERLAY DEL MEN√ö DE NIVELES -->
  <div id="levelMenuOverlay" class="overlay hidden">
    <div class="level-menu">
      <div class="level-menu-header">
        <h3>Mapa de niveles ‚Äì Escape SAMR</h3>
        <button class="secondary" onclick="closeLevelMenu()">Cerrar</button>
      </div>
      <p class="small">
        Selecciona un nivel. Solo puedes avanzar en orden, pero puedes repetir niveles ya desbloqueados para mejorar tus estrellas.
      </p>
      <div class="levels-grid" id="levelMenuGrid"></div>
    </div>
  </div>

  <div id="levelCompleteOverlay" class="overlay hidden">
    <div class="level-complete" id="levelCompleteBox"></div>
  </div>

</div>

<script>
  // ------------------------
  // Datos del juego
  // ------------------------

  const levels = [
    {
      name: "Nivel 1 ‚Äì ¬øQu√© es SAMR?",
      story: "Las luces de emergencia parpadean en el pasillo principal de La Zona Roja. Para abrir la primera compuerta, el sistema te reta a demostrar que realmente sabes qu√© es el modelo SAMR.",
      questions: [
        {
          type: "mcq",
          title: "Prop√≥sito del modelo",
          text: "¬øPara qu√© se utiliza principalmente el modelo SAMR?",
          options: [
            "Para medir la asistencia de los estudiantes en clase.",
            "Para clasificar el nivel de integraci√≥n de la tecnolog√≠a en las actividades de aprendizaje.",
            "Para evaluar √∫nicamente la calidad de los dispositivos digitales.",
            "Para decidir qu√© asignaturas se eliminan del plan de estudios."
          ],
          correctIndex: 1,
          hintOnWrong: "Piensa en SAMR como una forma de analizar c√≥mo se usa la tecnolog√≠a dentro de las actividades, no solo los dispositivos."
        },
        {
          type: "vf",
          title: "Verdadero o falso",
          text: "SAMR ayuda a reflexionar sobre c√≥mo la tecnolog√≠a puede transformar las tareas educativas, no solo a digitalizarlas.",
          options: ["Verdadero", "Falso"],
          correctIndex: 0,
          hintOnWrong: "Reflexiona si SAMR se queda en cambiar papel por pantalla o si busca ir m√°s all√°."
        },
        {
          type: "mcq",
          title: "Componentes del modelo",
          text: "¬øCu√°l de las siguientes opciones corresponde a las cuatro etapas del modelo SAMR?",
          options: [
            "Sustituci√≥n, Aumento, Modificaci√≥n y Redefinici√≥n.",
            "Sustituci√≥n, Aumento, Motivaci√≥n y Retroalimentaci√≥n.",
            "Simulaci√≥n, An√°lisis, Medici√≥n y Revisi√≥n.",
            "Selecci√≥n, Adaptaci√≥n, Mejora y Revisi√≥n."
          ],
          correctIndex: 0,
          hintOnWrong: "Recuerda que SAMR es un acr√≥nimo en ingl√©s; cada letra corresponde a una etapa espec√≠fica."
        }
      ]
    },
    {
      name: "Nivel 2 ‚Äì Sustituci√≥n y Aumento",
      story: "Has desbloqueado la primera compuerta, pero el pasillo se inunda lentamente. El sistema ahora quiere saber si distingues entre un uso b√°sico de la tecnolog√≠a y un uso mejorado.",
      questions: [
        {
          type: "case",
          title: "Caso 1",
          text: "Un docente pide a sus estudiantes que, en vez de escribir un ensayo a mano, lo redacten en un procesador de texto sin cambiar nada m√°s de la actividad. ¬øQu√© nivel de SAMR describe mejor esta situaci√≥n?",
          options: ["Sustituci√≥n", "Aumento", "Modificaci√≥n", "Redefinici√≥n"],
          correctIndex: 0,
          hintOnWrong: "Analiza si la tecnolog√≠a solo reemplaza la herramienta o si agrega mejoras funcionales importantes."
        },
        {
          type: "case",
          title: "Caso 2",
          text: "Los estudiantes realizan un cuestionario en l√≠nea que les ofrece retroalimentaci√≥n inmediata, estad√≠sticas de aciertos, tiempo de respuesta y sugerencias de repaso. Antes el cuestionario era en papel y sin comentarios.",
          options: ["Sustituci√≥n", "Aumento", "Modificaci√≥n", "Redefinici√≥n"],
          correctIndex: 1,
          hintOnWrong: "Piensa si aqu√≠ la tecnolog√≠a a√±ade ventajas funcionales claras en comparaci√≥n con la versi√≥n en papel."
        },
        {
          type: "vf",
          title: "Diferencia clave",
          text: "En la sustituci√≥n, la tecnolog√≠a reemplaza a la herramienta tradicional sin a√±adir mejoras importantes, mientras que en el aumento s√≠ se incluyen mejoras funcionales.",
          options: ["Verdadero", "Falso"],
          correctIndex: 0,
          hintOnWrong: "Revisa la diferencia entre usar tecnolog√≠a como simple reemplazo y usarla para mejorar la misma tarea."
        }
      ]
    },
    {
      name: "Nivel 3 ‚Äì Modificaci√≥n y Redefinici√≥n",
      story: "Las puertas siguientes llevan a un laboratorio inestable. Para avanzar, debes demostrar que entiendes c√≥mo la tecnolog√≠a puede transformar y redefinir las tareas.",
      questions: [
        {
          type: "case",
          title: "Caso 3",
          text: "Los estudiantes elaboran un informe colaborativo en un documento en l√≠nea, comentan en tiempo real, hacen correcciones simult√°neas y el docente puede revisar el historial de cambios.",
          options: ["Sustituci√≥n", "Aumento", "Modificaci√≥n", "Redefinici√≥n"],
          correctIndex: 2,
          hintOnWrong: "Reflexiona si aqu√≠ la tarea se redise√±a de forma significativa gracias a la colaboraci√≥n en l√≠nea."
        },
        {
          type: "case",
          title: "Caso 4",
          text: "Un grupo de estudiantes crea un podcast educativo con entrevistas a expertos internacionales conectados por videoconferencia. El podcast se publica en plataformas abiertas para que otras escuelas lo usen.",
          options: ["Sustituci√≥n", "Aumento", "Modificaci√≥n", "Redefinici√≥n"],
          correctIndex: 3,
          hintOnWrong: "Pregunta si esta tarea habr√≠a sido muy dif√≠cil o casi imposible sin tecnolog√≠a digital."
        },
        {
          type: "mcq",
          title: "Modificaci√≥n vs Redefinici√≥n",
          text: "¬øCu√°l enunciado describe mejor la diferencia entre Modificaci√≥n y Redefinici√≥n?",
          options: [
            "En Modificaci√≥n se eliminan tareas, y en Redefinici√≥n se repiten igual.",
            "En Modificaci√≥n se redise√±a la tarea, mientras que en Redefinici√≥n se crean tareas nuevas que antes no eran posibles.",
            "En Modificaci√≥n se usan m√°s dispositivos, y en Redefinici√≥n menos.",
            "No existe diferencia entre ambas; son sin√≥nimos."
          ],
          correctIndex: 1,
          hintOnWrong: "Piensa en qu√© nivel la tecnolog√≠a permite actividades que antes no podr√≠an haberse realizado."
        }
      ]
    },
    {
      name: "Nivel 4 ‚Äì Ventajas y aplicaci√≥n en el aula",
      story: "Est√°s a punto de llegar a la salida de La Zona Roja, pero una √∫ltima compuerta pide evidencia de que sabes usar SAMR para mejorar la ense√±anza, no solo memorizarlo.",
      questions: [
        {
          type: "mcq",
          title: "Ventaja principal",
          text: "Una de las ventajas de aplicar SAMR en el dise√±o de clases es:",
          options: [
            "Elegir la marca de computadoras m√°s cara.",
            "Reflexionar sobre el impacto de la tecnolog√≠a y avanzar hacia usos cada vez m√°s significativos.",
            "Eliminar todas las actividades sin tecnolog√≠a.",
            "Obligar a que todas las tareas se hagan en el m√°ximo nivel."
          ],
          correctIndex: 1,
          hintOnWrong: "Conc√©ntrate en c√≥mo SAMR gu√≠a la reflexi√≥n y la mejora del uso de la tecnolog√≠a."
        },
        {
          type: "vf",
          title: "Uso flexible",
          text: "Es obligatorio que todas las actividades lleguen al nivel de Redefinici√≥n para que la tecnolog√≠a sea considerada v√°lida.",
          options: ["Verdadero", "Falso"],
          correctIndex: 1,
          hintOnWrong: "Reflexiona si siempre es necesario llegar al nivel m√°s alto o si depende de los objetivos pedag√≥gicos."
        },
        {
          type: "case",
          title: "Planificaci√≥n docente",
          text: "Como estudiante de la MTAC, dise√±as una actividad donde los alumnos primero digitalizan un texto (Sustituci√≥n o Aumento) y luego crean un proyecto multimedia colaborativo que se comparte m√°s all√° del aula. ¬øC√≥mo te ayuda SAMR en este proceso?",
          options: [
            "Solo sirve para saber cu√°ntas computadoras usar.",
            "Permite planear un progreso desde usos b√°sicos hasta tareas m√°s transformadoras con tecnolog√≠a.",
            "Te obliga a eliminar cualquier actividad sin tecnolog√≠a.",
            "Evita que cambies tu planificaci√≥n original."
          ],
          correctIndex: 1,
          hintOnWrong: "Piensa en SAMR como una gu√≠a para pasar de lo b√°sico a lo transformador, no como una regla r√≠gida."
        }
      ]
    }
  ];

  const characters = {
    spiderman: {
      name: "Spider-Man",
      img: "https://i.pinimg.com/736x/2f/e4/38/2fe438cd401b5f7ac6f0ffb109ad87ff.jpg"
    },
    harley: {
      name: "Harley Quinn",
      img: "https://i.pinimg.com/1200x/61/9b/ee/619bee565f4aa622669c621a403fe6b2.jpg" // Cambia este enlace por una imagen PNG/SVG si lo necesitas
    }
  };

  let currentLevelIndex = 0;
  let currentQuestionIndex = 0;
  let errorsThisLevel = 0;
  let levelStars = new Array(levels.length).fill(0);
  let playerName = "";
  let selectedOptionIndex = null;
  let waitingNextQuestion = false;
  let furthestCompleted = -1; // √≠ndice del √∫ltimo nivel COMPLETADO
  let selectedCharacter = "spiderman";
  let correctStreak = 0;
  let starThreeStreak = 0;
  let achievements = { perfectLevel: false, threeStarsStreak3: false };
  

  function $(id) {
    return document.getElementById(id);
  }

  updateCharacterPreview();

  // ------------------------
  // Flujo de pantallas
  // ------------------------

  function startGame() {
    const nameInput = $("playerName").value.trim();
    playerName = nameInput || "Estudiante";
    $("playerLabel").textContent = `Agente: ${playerName} (MTAC)`;
    $("charName").textContent = `Agente ${playerName} ‚Äì ${characters[selectedCharacter].name}`;
    $("startCharName").textContent = `Agente: ${playerName} (MTAC)`;

    loadAchievements();

    // Reseteamos estado general
    currentLevelIndex = 0;
    currentQuestionIndex = 0;
    errorsThisLevel = 0;
    waitingNextQuestion = false;
    furthestCompleted = -1;
    levelStars = new Array(levels.length).fill(0);
    selectedCharacter = "spiderman";

    $("screen-start").classList.add("hidden");
    $("screen-map").classList.remove("hidden");

    $("mapPlayerName").textContent = playerName;
    updateLevelLabel();
    updateProgressBar();
    renderWorldLevelGrid();
    renderLevelMenu();
    updateCharacterPreview();

    
    const actionsPanel = $("actionsPanel");
    if (actionsPanel && window.matchMedia && window.matchMedia('(max-width: 480px)').matches) {
      actionsPanel.classList.remove('open');
    }
  }

  function backToStart() {
    $("screen-map").classList.add("hidden");
    $("screen-start").classList.remove("hidden");
  }

  function goToSuggestedLevel() {
    // Sugerimos el primer nivel desbloqueado
    const suggestedIndex = Math.max(0, furthestCompleted + 1);
    jumpToLevel(suggestedIndex);
    enterLevelFromMap();
  }

  function enterLevelFromMap() {
    $("screen-map").classList.add("hidden");
    $("screen-game").classList.remove("hidden");
    $("playerLabel").textContent = `Agente: ${playerName} (MTAC)`;
    $("charName").textContent = `Agente ${playerName} ‚Äì ${characters[selectedCharacter].name}`;
    updateCharacterPreview();
    updateProgressBar();
  }

  function backToWorldMap() {
    $("screen-game").classList.add("hidden");
    $("screen-map").classList.remove("hidden");
    $("mapPlayerName").textContent = playerName;
    renderWorldLevelGrid();
    renderLevelMenu();
    updateCharacterPreview();
  }

  // ------------------------
  // L√≥gica del juego
  // ------------------------

  function updateLevelLabel() {
    $("levelLabel").textContent = levels[currentLevelIndex].name;
  }

  function showStory() {
    const text = levels[currentLevelIndex].story;
    $("storyBox").innerHTML = `<div class="story-title">Historia</div><p>${text}</p>`;
    $("storyBox").classList.remove("hidden");
  }

  function showQuestion() {
    const level = levels[currentLevelIndex];
    const question = level.questions[currentQuestionIndex];

    $("questionTitle").textContent = question.title;
    $("questionText").textContent = question.text;

    const optionsContainer = $("optionsContainer");
    optionsContainer.innerHTML = "";
    selectedOptionIndex = null;
    waitingNextQuestion = false;

    question.options.forEach((optionText, index) => {
      const btn = document.createElement("button");
      btn.className = "option-btn";
      btn.textContent = optionText;
      btn.onclick = () => selectOption(index);
      btn.onmousedown = (ev) => spawnRipple(btn, ev);
      optionsContainer.appendChild(btn);
    });

    $("feedbackBox").classList.add("hidden");
    $("feedbackBox").textContent = "";
    $("feedbackBox").classList.remove("correct", "incorrect");
    $("nextBtn").textContent = "Responder";
    $("repeatLevelBtn").classList.add("hidden");
    $("goToMapBtn").classList.add("hidden");
    $("levelSummary").classList.add("hidden");
  }

  function selectOption(index) {
    selectedOptionIndex = index;
    const optionButtons = $("optionsContainer").querySelectorAll(".option-btn");
    optionButtons.forEach((btn, i) => {
      btn.classList.toggle("selected", i === index);
    });
  }

  function nextStep() {
    if ($("nextBtn").textContent === "Siguiente nivel") {
      goToNextLevel();
      return;
    }

    if ($("nextBtn").textContent === "Ver resumen final") {
      showFinalSummary();
      return;
    }

    if (waitingNextQuestion) {
      pulseElement("nextBtn");
      goToNextQuestionOrEndLevel();
      return;
    }

    const level = levels[currentLevelIndex];
    const question = level.questions[currentQuestionIndex];

    if (selectedOptionIndex === null) {
      showFeedback("Selecciona una opci√≥n antes de continuar.", false, true);
      return;
    }

    const isCorrect = selectedOptionIndex === question.correctIndex;
    if (isCorrect) {
      correctStreak++;
      const sb = $("streakBox");
      if (sb) { sb.textContent = `Racha de aciertos: ${correctStreak}`; sb.classList.remove("hidden"); }
      showFeedback("¬°Correcto! Has superado este reto.", true);
      playCorrect();
      waitingNextQuestion = true;
      $("nextBtn").textContent = "Siguiente";
    } else {
      correctStreak = 0;
      const sb = $("streakBox");
      if (sb) { sb.textContent = `Racha de aciertos: ${correctStreak}`; }
      errorsThisLevel++;
      showFeedback(question.hintOnWrong, false);
      playIncorrect();
      screenFlash("rgba(239,68,68,0.25)");
      // misma pregunta, intentos ilimitados
    }
  }

  function showFeedback(message, correct, isNeutral = false) {
    const box = $("feedbackBox");
    box.textContent = message;
    box.classList.remove("hidden", "correct", "incorrect");
    if (isNeutral) return;
    if (correct) {
      box.classList.add("correct");
      box.classList.remove("incorrect");
    } else {
      box.classList.add("incorrect");
      box.classList.remove("correct");
    }
  }

  function goToNextQuestionOrEndLevel() {
    const level = levels[currentLevelIndex];

    if (currentQuestionIndex < level.questions.length - 1) {
      currentQuestionIndex++;
      showQuestion();
      updateProgressBar();
    } else {
      finishLevel();
    }
  }

  function finishLevel() {
    let stars = 1;
    if (errorsThisLevel === 0) {
      stars = 3;
    } else if (errorsThisLevel <= 2) {
      stars = 2;
    }

    if (stars > levelStars[currentLevelIndex]) {
      levelStars[currentLevelIndex] = stars;
    }

    if (currentLevelIndex > furthestCompleted) {
      furthestCompleted = currentLevelIndex;
    }

    if (stars === 3) { starThreeStreak++; } else { starThreeStreak = 0; }
    if (errorsThisLevel === 0) { achievements.perfectLevel = true; }
    if (starThreeStreak >= 3) { achievements.threeStarsStreak3 = true; }
    try {
      localStorage.setItem("achievements", JSON.stringify(achievements));
      localStorage.setItem("starThreeStreak", String(starThreeStreak));
    } catch (_) {}
    $("levelSummary").classList.add("hidden");
    openLevelCompleteOverlay(stars);

    waitingNextQuestion = false;
    updateProgressBar(true);
    renderLevelMenu();
    renderWorldLevelGrid();
    playLevelComplete();
  }

  function repeatLevel() {
    errorsThisLevel = 0;
    currentQuestionIndex = 0;
    showQuestion();
    updateProgressBar();
  }

  function goToNextLevel() {
    if (currentLevelIndex < levels.length - 1) {
      currentLevelIndex++;
      currentQuestionIndex = 0;
      errorsThisLevel = 0;
      updateLevelLabel();
      showStory();
      showQuestion();
      updateProgressBar();
      renderLevelMenu();
      renderWorldLevelGrid();
    }
  }

  function updateProgressBar(endOfLevel = false) {
    const level = levels[currentLevelIndex];
    let percent = 0;
    if (level && level.questions && level.questions.length > 0) {
      percent = endOfLevel ? 100 : (currentQuestionIndex / level.questions.length) * 100;
    }
    if (percent > 100) percent = 100;
    if (percent < 0) percent = 0;
    $("progressBar").style.width = Math.round(percent) + "%";
    $("progressBar").title = `Progreso del nivel: ${Math.round(percent)}%`;
  }

  // ------------------------
  // Resumen final
  // ------------------------

  function showFinalSummary() {
    $("screen-game").classList.add("hidden");
    $("screen-final").classList.remove("hidden");

    const totalStars = levelStars.reduce((a, b) => a + b, 0);
    const maxStars = levels.length * 3;

    $("finalIntro").textContent = `${playerName}, has completado la misi√≥n en La Zona Roja de Tabasco. Tu desempe√±o en el modelo SAMR fue de ${totalStars} de ${maxStars} estrellas posibles.`;

    const levelsGrid = $("levelsGrid");
    levelsGrid.innerHTML = "";
    levels.forEach((level, index) => {
      const card = document.createElement("div");
      card.className = "level-card";

      const stars = "‚òÖ".repeat(levelStars[index]) + "‚òÜ".repeat(3 - levelStars[index]);

      card.innerHTML = `
        <h4>${level.name}</h4>
        <p>Estrellas: <span class="stars">${stars}</span></p>
      `;
      levelsGrid.appendChild(card);
    });

    $("finalComment").textContent = buildFinalComment(totalStars);
  }

  function buildFinalComment(totalStars) {
    const maxStars = levels.length * 3;
    const ratio = totalStars / maxStars;

    if (ratio >= 0.85) {
      return "Conoces muy bien el modelo SAMR y sabes aplicar sus niveles de forma coherente. Conoces bien SAMR, pero podr√≠as reforzar la diferencia entre Modificaci√≥n y Redefinici√≥n en situaciones m√°s complejas para consolidar todav√≠a m√°s tu dominio.";
    } else if (ratio >= 0.55) {
      return "Vas por muy buen camino: distingues el significado general de SAMR y sus niveles, pero a√∫n puedes afinar la identificaci√≥n entre Sustituci√≥n/Aumento y, sobre todo, entre Modificaci√≥n y Redefinici√≥n. Revisa ejemplos de aula y preg√∫ntate qu√© tan transformadora es la tecnolog√≠a en cada caso.";
    } else {
      return "Has dado los primeros pasos para comprender SAMR, pero te conviene reforzar especialmente la diferencia entre Modificaci√≥n y Redefinici√≥n, as√≠ como volver a revisar en qu√© se distinguen la Sustituci√≥n y el Aumento. Utiliza el glosario y practica con m√°s ejemplos de actividades para afianzar el modelo.";
    }
  }

  // ------------------------
  // Glosario y extras
  // ------------------------

  function toggleGlosario() {
    $("glosarioBox").classList.toggle("hidden");
  }
  function toggleActionsPanel() {
    const panel = $("actionsPanel");
    if (!panel) return;
    panel.classList.toggle("open");
  }
  function openLevelCompleteOverlay(stars) {
    const overlay = $("levelCompleteOverlay");
    const box = $("levelCompleteBox");
    if (!overlay || !box) return;
    const starText = "‚òÖ".repeat(stars) + "‚òÜ".repeat(3 - stars);
    const isLast = currentLevelIndex >= levels.length - 1;
    box.classList.add("pop-in");
    const badges = [];
    if (errorsThisLevel === 0) badges.push("‚úÖ Sin errores");
    if (starThreeStreak >= 3) badges.push("‚≠ê 3 estrellas seguidas");
    const badgesHtml = badges.length ? `<div class="badges">${badges.map(b=>`<span class=\"badge\">${b}</span>`).join("")}</div>` : "";
    box.innerHTML = `
      <h3>Nivel completado</h3>
      <p>Has completado <strong>${levels[currentLevelIndex].name}</strong>.</p>
      <p>Errores en este intento: <strong>${errorsThisLevel}</strong></p>
      <p>Estrellas obtenidas: <span class="stars glint">${starText}</span></p>
      ${badgesHtml}
      <div class="actions" style="justify-content:space-between;">
        <button class="secondary" onclick="closeLevelCompleteOverlay(); repeatLevel()">Repetir nivel</button>
        <button class="secondary" onclick="closeLevelCompleteOverlay(); backToWorldMap()">Mapa del mundo</button>
        ${isLast
          ? `<button class="primary" onclick="closeLevelCompleteOverlay(); showFinalSummary()">Ver resumen final</button>`
          : `<button class="primary" onclick="closeLevelCompleteOverlay(); goToNextLevel()">Siguiente nivel</button>`}
      </div>
    `;
    overlay.classList.remove("hidden");
  }
  function closeLevelCompleteOverlay() {
    const overlay = $("levelCompleteOverlay");
    if (overlay) overlay.classList.add("hidden");
  }
  function fireConfetti(count, colors) {
    const w = window.innerWidth;
    for (let i = 0; i < count; i++) {
      const el = document.createElement("span");
      el.className = "confetti-piece";
      const left = Math.random() * w;
      const size = 6 + Math.random() * 8;
      const dur = 1200 + Math.random() * 1800;
      const delay = Math.random() * 200;
      el.style.left = left + "px";
      el.style.width = size + "px";
      el.style.height = (size * 1.5) + "px";
      el.style.background = colors[Math.floor(Math.random() * colors.length)];
      el.style.animationDuration = dur + "ms, " + dur + "ms";
      el.style.animationDelay = delay + "ms, " + delay + "ms";
      document.body.appendChild(el);
      setTimeout(() => { if (el && el.parentNode) el.parentNode.removeChild(el); }, dur + delay + 100);
    }
  }
  function spawnRipple(el, ev) {
    const rect = el.getBoundingClientRect();
    const x = ev.clientX - rect.left;
    const y = ev.clientY - rect.top;
    const d = Math.max(rect.width, rect.height);
    const ripple = document.createElement("span");
    ripple.className = "ripple";
    ripple.style.width = ripple.style.height = d + "px";
    ripple.style.left = (x - d/2) + "px";
    ripple.style.top = (y - d/2) + "px";
    el.appendChild(ripple);
    setTimeout(() => { if (ripple && ripple.parentNode) ripple.parentNode.removeChild(ripple); }, 600);
  }
  function pulseElement(elId) {
    const el = $(elId);
    if (!el) return;
    el.classList.add("pulse");
    setTimeout(() => el.classList.remove("pulse"), 520);
  }
  function screenFlash(color) {
    const f = document.createElement("div");
    f.className = "screen-flash";
    f.style.background = color;
    document.body.appendChild(f);
    setTimeout(() => { if (f && f.parentNode) f.parentNode.removeChild(f); }, 380);
  }

  function showGlosarioFinal() {
    $("finalGlosario").classList.toggle("hidden");
  }

  function resetGame() {
    currentLevelIndex = 0;
    currentQuestionIndex = 0;
    errorsThisLevel = 0;
    levelStars = new Array(levels.length).fill(0);
    furthestCompleted = -1;
    selectedCharacter = "spiderman";

    $("screen-final").classList.add("hidden");
    $("screen-start").classList.remove("hidden");
    $("finalGlosario").classList.add("hidden");
    $("playerName").value = "";
    $("startCharName").textContent = "Agente: Estudiante MTAC";
    updateProgressBar();
    renderLevelMenu();
    renderWorldLevelGrid();
  }

  function toggleStartStory() {
    const box = $("startStoryExtra");
    const btn = $("startStoryToggleBtn");
    const willShow = box.classList.contains("hidden");
    box.classList.toggle("hidden");
    if (btn) btn.textContent = willShow ? "Ocultar" : "Leer m√°s";
  }

  function toggleDocNote() {
    const box = $("docNoteBox");
    const btn = $("toggleDocNoteBtn");
    const willShow = box.classList.contains("hidden");
    box.classList.toggle("hidden");
    if (btn) btn.textContent = willShow ? "Ocultar nota" : "Ver nota para docentes";
  }

  function toggleStory() {
    const box = $("storyBox");
    const btn = $("toggleStoryBtn");
    const willShow = box.classList.contains("hidden");
    box.classList.toggle("hidden");
    if (btn) btn.textContent = willShow ? "Ocultar historia" : "Mostrar historia";
  }

  // ------------------------
  // Men√∫ de niveles (overlay)
  // ------------------------

  function openLevelMenu() {
    renderLevelMenu();
    $("levelMenuOverlay").classList.remove("hidden");
  }

  function closeLevelMenu() {
    $("levelMenuOverlay").classList.add("hidden");
  }

  function renderLevelMenu() {
    const grid = $("levelMenuGrid");
    if (!grid) return;
    grid.innerHTML = "";

    const unlockedLimit = furthestCompleted + 1; // nivel que puedes jugar (siguiente al completado)

    levels.forEach((level, index) => {
      const card = document.createElement("div");
      card.className = "level-card";

      const stars = "‚òÖ".repeat(levelStars[index]) + "‚òÜ".repeat(3 - levelStars[index]);

      let statusClass = "status-locked";
      let statusText = "Bloqueado";

      if (index === currentLevelIndex) {
        statusClass = "status-current";
        statusText = "En curso";
      } else if (index <= unlockedLimit) {
        statusClass = "status-unlocked";
        statusText = "Desbloqueado";
      }

      const locked = index > unlockedLimit;

      card.innerHTML = `
        <h4>${level.name}</h4>
        <p>Estrellas: <span class="stars">${stars}</span></p>
        <p><span class="status-label ${statusClass}">${statusText}</span></p>
      `;

      const btn = document.createElement("button");
      btn.textContent = locked ? "Bloqueado" : "Jugar este nivel";
      btn.className = "secondary";
      btn.disabled = locked;
      btn.onclick = () => {
        if (!locked) {
          jumpToLevel(index);
          closeLevelMenu();
        }
      };

      card.appendChild(btn);
      grid.appendChild(card);
    });
  }

  // ------------------------
  // Mapa del mundo (pantalla intermedia)
  // ------------------------

  function renderWorldLevelGrid() {
    const grid = $("worldLevelGrid");
    if (!grid) return;
    grid.innerHTML = "";

    const unlockedLimit = furthestCompleted + 1; // √≠ndice m√°ximo desbloqueado

    levels.forEach((level, index) => {
      const card = document.createElement("div");
      card.className = "level-card";

      const stars = "‚òÖ".repeat(levelStars[index]) + "‚òÜ".repeat(3 - levelStars[index]);

      let statusClass = "status-locked";
      let statusText = "Bloqueado";

      if (furthestCompleted === -1 && index === 0) {
        statusClass = "status-current";
        statusText = "Inicio sugerido";
      } else if (index <= unlockedLimit) {
        statusClass = index === unlockedLimit && furthestCompleted >= 0
          ? "status-current"
          : "status-unlocked";
        statusText = index === unlockedLimit && furthestCompleted >= 0
          ? "Siguiente reto"
          : "Desbloqueado";
      }

      const locked = index > unlockedLimit;

      card.innerHTML = `
        <h4>${level.name}</h4>
        <p>Estrellas: <span class="stars">${stars}</span></p>
        <p><span class="status-label ${statusClass}">${statusText}</span></p>
      `;

      const btn = document.createElement("button");
      btn.textContent = locked ? "Bloqueado" : "Jugar aqu√≠";
      btn.className = "primary";
      btn.disabled = locked;
      btn.onclick = () => {
        if (!locked) {
          jumpToLevel(index);
          enterLevelFromMap();
        }
      };

      card.appendChild(btn);
      grid.appendChild(card);
    });
  }

  function jumpToLevel(index) {
    currentLevelIndex = index;
    currentQuestionIndex = 0;
    errorsThisLevel = 0;
    updateLevelLabel();
    showStory();
    showQuestion();
    updateProgressBar();
  }

  // ------------------------
  // Selecci√≥n de personaje
  // ------------------------

  function chooseCharacter(type) {
    selectedCharacter = type;
    $("charName").textContent = `Agente ${playerName} ‚Äì ${characters[selectedCharacter].name}`;
    updateCharacterPreview();
  }

  function updateCharacterPreview() {
    const data = characters[selectedCharacter];

    if ($("selectedCharacterLabel")) {
      $("selectedCharacterLabel").textContent = data.name;
    }

    const spCard = $("char-spiderman");
    const hCard = $("char-harley");
    if (spCard && hCard) {
      spCard.classList.toggle("selected", selectedCharacter === "spiderman");
      hCard.classList.toggle("selected", selectedCharacter === "harley");
    }

    const avatarGame = $("gameAvatarImg");
    if (avatarGame) {
      avatarGame.src = data.img;
      avatarGame.alt = data.name;
    }
    const spImg = document.querySelector("#char-spiderman .character-avatar img");
    if (spImg) { spImg.src = characters.spiderman.img; spImg.alt = characters.spiderman.name; }
    const hImg = document.querySelector("#char-harley .character-avatar img");
    if (hImg) { hImg.src = characters.harley.img; hImg.alt = characters.harley.name; }
  }
  

  

  function playCorrect() { try { fireConfetti(80, ["#34d399","#fde047","#c4b5fd","#60a5fa","#fca5a5"]); } catch (_) {} }
  function playIncorrect() { try { fireConfetti(25, ["#ef4444","#f59e0b","#f87171"]); const qb = $("optionsContainer"); if (qb) { qb.classList.add("shake"); setTimeout(()=>qb.classList.remove("shake"), 500); } } catch (_) {} }
  function playLevelComplete() { try { fireConfetti(150, ["#34d399","#fde047","#c4b5fd","#60a5fa","#fca5a5","#f472b6"]); } catch (_) {} }
  function loadAchievements() {
    try {
      if (typeof window === "undefined" || !window.localStorage) return;
      const rawA = localStorage.getItem("achievements");
      let parsedA = null;
      try { parsedA = rawA ? JSON.parse(rawA) : null; } catch (_) { parsedA = null; }
      if (parsedA && typeof parsedA === "object") {
        achievements = Object.assign({}, achievements, parsedA);
      }
      const s3 = localStorage.getItem("starThreeStreak");
      const n = Number.parseInt(s3 || "", 10);
      if (!Number.isNaN(n)) starThreeStreak = n;
    } catch (_) {}
  }
</script>
</body>
</html>
